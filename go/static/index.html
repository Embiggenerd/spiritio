<!DOCTYPE html>
<html lang="en">

<head>
    <title>Chat</title>

    <style type="text/css">
        html {
            overflow: hidden;
            height: 100%;
        }

        body {
            overflow: hidden;
            padding: 0;
            margin: 0;
            width: 100%;
            height: 100%;
            background: gray;
        }

        #log {
            background: white;
            height: 100%;
            /* margin: 0; */
            /* padding: 0.5em 0.5em 0.5em 0.5em; */
            /* position: absolute; */
            /* top: 0.5em;
            left: 0.5em;
            right: 0.5em;
            bottom: 3em; */
            overflow: auto;
            height: 500px;
        }

        #form {
            padding: 0 0.5em 0 0.5em;
            margin: 0;
            /* position: absolute; */
            bottom: 1em;
            left: 0px;
            width: 100%;

            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: row;
            /* height: 100vh; */
            /* width: 100%; */
            padding: 60px 30px;
            justify-content: space-evenly;
            align-items: end;
        }

        .video_audio {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            align-items: center;
            justify-content: space-between;
        }

        .chat {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            max-width: 300px;
            /* height: 100% */
        }

        .remote_video {
            width: 100%;
            aspect-ratio: 4 3;
        }

        #remoteVideos {
            /* width: 100%; */
        }
    </style>
</head>

<body>
    <!-- <video id="localVideo" autoplay playsinline controls="false" /> -->
    <div class="container">
        <div class="video_audio">
            <div id="remoteVideos"></div>
            <h3>You</h3>
            <video id="localVideo" width="160" height="120" autoplay muted></video>
        </div>
        <div class="chat">
            <div id="log"></div>
            <form id="form">
                <input type="submit" value="Send" />
                <input type="text" id="msg" size="64" autofocus />
            </form>
        </div>
    </div>
</body>
<script type="text/javascript">
    //     (async function () {
    //         console.log(this);  // window

    //         function handleTextStream(ws, evt) {
    //             const jsonMsg = JSON.parse(evt.data)
    //             const message = jsonMsg.data;
    //             var item = document.createElement("div");
    //             item.innerText = message;
    //             appendLog(item);
    //         }

    //         function handleVideoAudioStreamMessage(ws, evt, pc) {
    //             let msg = JSON.parse(evt.data)
    //             console.log("handleVideoAudioStreamMessage", evt.data, msg)

    //             if (!msg) {
    //                 return console.log('failed to parse msg')
    //             }

    //             switch (msg.event) {
    //                 case 'offer':
    //                     let offer = JSON.parse(msg.data)
    //                     if (!offer) {
    //                         return console.log('failed to parse answer')
    //                     }
    //                     pc.setRemoteDescription(offer)
    //                     pc.createAnswer().then(answer => {
    //                         pc.setLocalDescription(answer)
    //                         ws.send(JSON.stringify({ event: 'answer', data: JSON.stringify(answer) }))
    //                     })
    //                     return

    //                 case 'candidate':
    //                     let candidate = JSON.parse(msg.data)
    //                     if (!candidate) {
    //                         return console.log('failed to parse candidate')
    //                     }

    //                     pc.addIceCandidate(candidate)
    //             }
    //         }

    //         function initVideoAudioStream(ws) {
    //             return navigator.mediaDevices.getUserMedia({ video: true, audio: true })
    //                 .then(stream => {
    //                     console.log("initVideoAudioStream stream")
    //                     const pc = new RTCPeerConnection()
    //                     pc.ontrack = function (event) {
    //                         console.log("on track", e.track)

    //                         if (event.track.kind === 'audio') {
    //                             return
    //                         }

    //                         let el = document.createElement(event.track.kind)
    //                         el.srcObject = event.streams[0]
    //                         el.autoplay = true
    //                         el.controls = true
    //                         document.getElementById('remoteVideos').appendChild(el)

    //                         event.track.onmute = function (event) {
    //                             el.play()
    //                         }

    //                         event.streams[0].onremovetrack = ({ track }) => {
    //                             if (el.parentNode) {
    //                                 el.parentNode.removeChild(el)
    //                             }
    //                         }
    //                     }

    //                     document.getElementById('localVideo').srcObject = stream
    //                     stream.getTracks().forEach(track => pc.addTrack(track, stream))

    //                     // let ws = new WebSocket("{{.}}")

    //                     // window.sendMessage = (message) => {
    //                     //     // const message = document.getElementById('message').value
    //                     //     console.log("send message called with data", message)
    //                     //     if (message === '') {
    //                     //         return alert('Message must not be empty')
    //                     //     }

    //                     //     ws.send(JSON.stringify({ event: 'user-message', data: JSON.stringify(message) }))
    //                     // }

    //                     pc.onicecandidate = e => {
    //                         console.log("on icecandidate", e.candidate)
    //                         if (!e.candidate) {
    //                             return
    //                         }
    //                         const json = { event: 'candidate', data: JSON.stringify(e.candidate) }
    //                         console.log("sending ice candidate event", json)

    //                         ws.send(JSON.stringify(json))
    //                     }

    //                     // ws.onclose = function (evt) {
    //                     //     window.alert("Websocket has closed")
    //                     // }

    //                     // ws.onmessage = function (evt) {

    //

    //                     // ws.onerror = function (evt) {
    //                     //     console.log("ERROR: " + evt.data)
    //                     // }
    //                     return pc
    //                 }).catch(window.alert)
    //         }
    //         const wsProtocol = document.location.hostname.includes("localhost") ? "ws://" : "wss://"
    //         let conn = null;
    //         if (window["WebSocket"]) {
    //             conn = new WebSocket(wsProtocol + document.location.host + "/ws");
    //         }



    //         const pc = await initVideoAudioStream(conn)

    //         const msg = document.getElementById("msg");
    //         const log = document.getElementById("log");

    //         function appendLog(item) {
    //             var doScroll = log.scrollTop > log.scrollHeight - log.clientHeight - 1;
    //             log.appendChild(item);
    //             if (doScroll) {
    //                 log.scrollTop = log.scrollHeight - log.clientHeight;
    //             }
    //         }

    //         document.getElementById("form").onsubmit = function () {
    //             if (!conn) {
    //                 return false;
    //             }
    //             if (!msg.value) {
    //                 return false;
    //             }
    //             const msghi = `{"event":"user-message","data":"${msg.value}"}`
    //             const json = JSON.parse(msghi)
    //             console.log("message submitted", { json })
    //             conn.send(msghi);
    //             msg.value = "";
    //             return false;
    //         };

    //         // if (window["WebSocket"]) {
    //         //     conn = new WebSocket(wsProtocol + document.location.host + "/ws");
    //         conn.onclose = function (evt) {
    //             const item = document.createElement("div");
    //             item.innerHTML = "<b>Connection closed.</b>";
    //             appendLog(item);
    //         };
    //         conn.onmessage = function (evt) {
    //             console.log("mesg received", evt.data)
    //             handleVideoAudioStreamMessage(conn, evt, pc)
    //             handleTextStream(conn, evt)
    //         };
    //         // } else {
    //         //     var item = document.createElement("div");
    //         //     item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
    //         //     appendLog(item);
    //         // }
    //         // };
    //     })(); 
</script>
<script>
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
            let pc = new RTCPeerConnection()
            pc.ontrack = function (event) {
                if (event.track.kind === 'audio') {
                    return
                }

                let el = document.createElement(event.track.kind)
                el.srcObject = event.streams[0]
                el.autoplay = true
                el.controls = true
                el.setAttribute("width", 440)
                el.setAttribute("height", 330)
                el.classList.add("remote_video")
                document.getElementById('remoteVideos').appendChild(el)

                event.track.onmute = function (event) {
                    el.play()
                }

                event.streams[0].onremovetrack = ({ track }) => {
                    if (el.parentNode) {
                        el.parentNode.removeChild(el)
                    }
                }
            }

            document.getElementById('localVideo').srcObject = stream
            stream.getTracks().forEach(track => pc.addTrack(track, stream))

            const wsProtocol = document.location.hostname.includes("localhost") ? "ws://" : "wss://"
            let ws = null;

            if (window["WebSocket"]) {
                ws = new WebSocket(wsProtocol + document.location.host + "/ws" + window.location.search);
            }
            document.getElementById("form").onsubmit = function (e) {
                e.preventDefault()
                if (!ws) {
                    return false;
                }
                if (!msg.value) {
                    return false;
                }
                const msghi = `{"event":"user-message","data":"${msg.value}"}`
                const json = JSON.parse(msghi)
                console.log("message submitted", { json })
                ws.send(msghi);
                msg.value = "";
                return false;
            };

            function handleTextStream(msg) {
                const message = msg.data;
                var item = document.createElement("div");
                item.innerText = message;
                appendLog(item);
            }


            function appendLog(item) {
                const log = document.getElementById("log")
                var doScroll = log.scrollTop > log.scrollHeight - log.clientHeight - 1;
                log.appendChild(item);
                if (doScroll) {
                    log.scrollTop = log.scrollHeight - log.clientHeight;
                }
            }


            // window.sendMessage = (message) => {
            //     // const message = document.getElementById('message').value
            //     console.log("send message called with data", message)
            //     if (message === '') {
            //         return alert('Message must not be empty')
            //     }

            //     ws.send(JSON.stringify({ event: 'user-message', data: JSON.stringify(message) }))
            // }

            //   let ws = new WebSocket("{{.}}")
            pc.onicecandidate = e => {
                if (!e.candidate) {
                    return
                }

                ws.send(JSON.stringify({ event: 'candidate', data: JSON.stringify(e.candidate) }))
            }

            ws.onclose = function (evt) {
                window.alert("Websocket has closed")
            }

            ws.onmessage = function (evt) {
                let msg = JSON.parse(evt.data)
                if (!msg) {
                    return console.log('failed to parse msg')
                }
                console.log("message received", msg)
                switch (msg.event) {
                    case 'offer':
                        let offer = JSON.parse(msg.data)
                        if (!offer) {
                            return console.log('failed to parse answer')
                        }
                        pc.setRemoteDescription(offer)
                        pc.createAnswer().then(answer => {
                            pc.setLocalDescription(answer)
                            ws.send(JSON.stringify({ event: 'answer', data: JSON.stringify(answer) }))
                        })
                        return

                    case 'candidate':
                        let candidate = JSON.parse(msg.data)
                        if (!candidate) {
                            return console.log('failed to parse candidate')
                        }

                        pc.addIceCandidate(candidate)
                        return

                    case 'user-message':
                        console.log("received user message", msg)
                        handleTextStream(msg)
                        return
                    case 'created-room':
                        const urlParams = new URLSearchParams(window.location.search);
                        urlParams.set('room', msg.data);
                        window.location.search = urlParams;
                        return
                    case 'joined-room':
                        console.log("joined room ", msg.data)
                }


            }

            ws.onerror = function (evt) {
                console.log("ERROR: " + evt.data)
            }
        }).catch(window.alert)
</script>

</html>